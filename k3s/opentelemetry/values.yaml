fullnameOverride: opentelemetry

revisionHistoryLimit: 3

mode: deployment

replicaCount: 1

image:
  repository: otel/opentelemetry-collector-contrib
  tag: 0.94.0 # Using a recent stable version
  pullPolicy: IfNotPresent

resources:
  requests:
    cpu: 20m
    memory: 100Mi
  limits:
    cpu: 150m
    memory: 256Mi

podSecurityContext:
  fsGroup: 10001
  runAsGroup: 10001
  runAsUser: 10001
  runAsNonRoot: true

securityContext:
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# Use alternateConfig to fully control the collector's configuration and avoid default merges
alternateConfig:
  extensions:
    health_check:
      endpoint: 0.0.0.0:13133
  receivers:
    otlp:
      protocols:
        grpc: {}
        http: {}
  processors:
    batch: {}
    resource:
      attributes:
        - key: service.name
          action: upsert
          from_attribute: service.name
  exporters:
    otlp:
      endpoint: tempo.observability:4317
      tls:
        insecure: true
    logging:
      loglevel: debug
    loki:
      endpoint: http://loki.observability:3100/loki/api/v1/push
    prometheusremotewrite:
      endpoint: http://prometheus-server.observability:80/api/v1/write
  service:
    telemetry:
      metrics:
        address: 0.0.0.0:8888
    extensions: [health_check] # Ensure health_check is used
    pipelines:
      traces:
        receivers: [otlp]
        processors: [batch]
        exporters: [otlp]
      metrics:
        receivers: [otlp]
        processors: [batch]
        exporters: [prometheusremotewrite]
      logs:
        receivers: [otlp]
        processors: [batch, resource]
        exporters: [loki]

# Expose as NodePort so host-level systemd services (e.g. proxy) can reach the collector
service:
  type: NodePort

ports:
  otlp:
    enabled: true
    servicePort: 4317
    nodePort: 30317
  otlp-http:
    enabled: true
    servicePort: 4318
    nodePort: 30318
  metrics:
    enabled: true
    containerPort: 8888
    servicePort: 8888
    protocol: TCP
  health-check:
    enabled: true
    containerPort: 13133
    servicePort: 13133
    protocol: TCP

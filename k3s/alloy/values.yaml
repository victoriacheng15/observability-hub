revisionHistoryLimit: 3

global:
  podSecurityContext:
    supplementalGroups:
      - 999 # systemd-journal on this host; confirm on all nodes

alloy:
  securityContext:
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    runAsUser: 1000
    capabilities:
      drop:
        - ALL
  mounts:
    extra:
      - name: journal-logs
        mountPath: /var/log/journal
        readOnly: true
      - name: runtime-journal-logs
        mountPath: /run/log/journal
        readOnly: true
      - name: machine-id
        mountPath: /etc/machine-id
        readOnly: true
      - name: tmp
        mountPath: /tmp
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi
  configMap:
    content: |-
      // WRITE: Push to local K3s-Loki
      loki.write "local_loki" {
        endpoint {
          url = "http://loki.observability.svc.cluster.local:3100/loki/api/v1/push"
        }
      }

      // SOURCE: Systemd Journal
      loki.source.journal "systemd" {
        forward_to    = [loki.process.journal_pipeline.receiver] // Parse first, then filter
        labels        = {
          agent = "alloy",
        }
      }

      // 1. PARSE the message and create the final labels
      loki.process "journal_pipeline" {
        stage.json {
          expressions = {
            extracted_job = "job",
            extracted_service = "service",
          }
        }
        stage.labels {
          values = {
            job = "extracted_job",
            service = "extracted_service",
          }
        }
        forward_to = [loki.relabel.journal_filter.receiver]
      }

      // 2. FILTER by parsed service label
      loki.relabel "journal_filter" {
        forward_to = [loki.write.local_loki.receiver]
        rule {
          source_labels = ["service"]
          regex         = "(gitops\\.sync|tailscale\\.gate)"
          action        = "keep"
        }
      }

configReloader:
  securityContext:
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    runAsUser: 65532
    capabilities:
      drop:
        - ALL
  resources:
    limits:
      cpu: 50m
      memory: 50Mi
    requests:
      cpu: 10m
      memory: 50Mi

controller:
  type: daemonset
  hostNetwork: false
  volumes:
    extra:
      - name: journal-logs
        hostPath:
          path: /var/log/journal
          type: DirectoryOrCreate
      - name: runtime-journal-logs
        hostPath:
          path: /run/log/journal
          type: DirectoryOrCreate
      - name: machine-id
        hostPath:
          path: /etc/machine-id
          type: File
      - name: tmp
        emptyDir: {}

server:
  revisionHistoryLimit: 3
  extraArgs:
    web.enable-remote-write-receiver: null
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 300m
      memory: 768Mi
  
  # Hardening server
  containerSecurityContext:
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    runAsUser: 65534 # nobody
    runAsGroup: 65534
    capabilities:
      drop:
        - ALL
  
  # sidecarConfigReloader for newer charts
  sidecarConfigReloader:
    resources:
      limits:
        cpu: 50m
        memory: 64Mi
      requests:
        cpu: 10m
        memory: 32Mi
    containerSecurityContext:
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      runAsUser: 65534
      capabilities:
        drop:
          - ALL

  # configmapReload for this specific chart version (v28.x)
  configmapReload:
    prometheus:
      resources:
        limits:
          cpu: 50m
          memory: 64Mi
        requests:
          cpu: 10m
          memory: 32Mi
      containerSecurityContext:
        readOnlyRootFilesystem: true
        allowPrivilegeEscalation: false
        runAsNonRoot: true
        runAsUser: 65534
        capabilities:
          drop:
            - ALL

  retention: 12h  # Lean retention for homelab
  persistentVolume:
    enabled: true
    size: 10Gi
    storageClass: local-path

  # Extra volumes for readOnlyRootFilesystem compatibility
  extraVolumes:
    - name: tmp
      emptyDir: {}
  extraVolumeMounts:
    - name: tmp
      mountPath: /tmp

# Scrape configuration for OpenTelemetry Collector
extraScrapeConfigs: |
  - job_name: 'otel-collector'
    scrape_interval: 10s
    static_configs:
      - targets: ['opentelemetry.observability:8888'] # Collector internal metrics
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: "otelcol_process_.*|up|scrape_.*"
        action: keep

# Scrape job configuration for single-node homelab
scrapeConfigs:
  kubernetes-service-endpoints:
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: "node_cpu_seconds_total|node_load(1|5|15)|node_memory_(MemTotal|MemAvailable|Buffers|Cached)_bytes|node_filesystem_(size|avail|free)_bytes|node_disk_(read|written)_bytes_total|node_disk_io_time_seconds_total|node_network_(receive|transmit)_bytes_total|node_hwmon_temp_celsius|node_boot_time_seconds|node_uname_info|kube_pod_status_phase|kube_pod_container_resource_requests|kube_pod_container_resource_limits|kube_pod_container_status_running|kube_pod_info|kube_deployment_status_replicas|kube_deployment_status_replicas_available|kube_deployment_spec_replicas|kube_node_status_allocatable|kube_node_status_capacity|kube_statefulset_status_replicas_ready|kube_statefulset_replicas|kube_daemonset_status_number_ready|kube_daemonset_status_desired_number_scheduled|kube_namespace_status_phase|up|scrape_.*"
        action: keep

  kubernetes-nodes-cadvisor:
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: "container_cpu_(usage_seconds_total|cfs_throttled_seconds_total|cfs_periods_total|cfs_throttled_periods_total)|container_memory_(working_set_bytes|rss|cache|usage_bytes)|container_network_(receive|transmit)_bytes_total|container_spec_(cpu_quota|cpu_period|memory_limit_bytes)|container_start_time_seconds|up|scrape_.*"
        action: keep

  prometheus:
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: "prometheus_tsdb_head_series|prometheus_tsdb_head_samples_appended_total|prometheus_tsdb_storage_blocks_bytes|prometheus_tsdb_wal_storage_size_bytes|prometheus_build_info|traces_.*|up|scrape_.*"
        action: keep

kube-state-metrics:
  revisionHistoryLimit: 3
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

prometheus-node-exporter:
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

# Disable unnecessary components to save resources
alertmanager:
  enabled: false
prometheus-pushgateway:
  enabled: false

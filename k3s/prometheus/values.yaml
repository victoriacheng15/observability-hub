server:
  revisionHistoryLimit: 3
  global:
    external_labels:
      cluster: homelab
  extraArgs:
    web.enable-remote-write-receiver: null
    storage.tsdb.retention.time: 24h # Shorten local TSDB retention
    storage.tsdb.min-block-duration: 2h
    storage.tsdb.max-block-duration: 2h
  resources:
    requests:
      cpu: 20m
      memory: 400Mi
    limits:
      cpu: 100m
      memory: 600Mi
  thanos:
    sidecar:
      enabled: true
      image: quay.io/thanos/thanos:v0.32.2 # Use appropriate version
      objectStorageConfig:
        name: minio-thanos-secret # Name of the secret containing MinIO credentials
        key: object-storage.yaml # Key within the secret for Thanos config

  extraContainers:
    - name: thanos-sidecar
      image: quay.io/thanos/thanos:v0.32.2
      args:
        - sidecar
        - --tsdb.path=/data
        - --grpc-address=0.0.0.0:10901
        - --http-address=0.0.0.0:10902
        - --prometheus.url=http://localhost:9090
        - --objstore.config-file=/etc/thanos/objstore.yml
      ports:
        - name: grpc
          containerPort: 10901
        - name: http
          containerPort: 10902
      volumeMounts:
        - name: storage-volume
          mountPath: /data
        - name: thanos-objstore-config
          mountPath: /etc/thanos
          readOnly: true
  
  # Hardening server
  containerSecurityContext:
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    runAsUser: 65534 # nobody
    runAsGroup: 65534
    capabilities:
      drop:
        - ALL
  
  # sidecarConfigReloader for newer charts
  sidecarConfigReloader:
    resources:
      limits:
        cpu: 50m
        memory: 64Mi
      requests:
        cpu: 10m
        memory: 32Mi
    containerSecurityContext:
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      runAsUser: 65534
      capabilities:
        drop:
          - ALL

  # configmapReload for this specific chart version (v28.x)
  configmapReload:
    prometheus:
      resources:
        limits:
          cpu: 50m
          memory: 64Mi
        requests:
          cpu: 10m
          memory: 32Mi
      containerSecurityContext:
        readOnlyRootFilesystem: true
        allowPrivilegeEscalation: false
        runAsNonRoot: true
        runAsUser: 65534
        capabilities:
          drop:
            - ALL

  retention: null # Disable default chart retention to avoid argument duplication
  persistentVolume:
    enabled: true
    size: 10Gi
    storageClass: local-path

  extraServices:
    - name: prometheus-thanos-grpc
      ports:
        - name: grpc
          protocol: TCP
          port: 10901
          targetPort: 10901
      selector:
        app.kubernetes.io/component: server
        app.kubernetes.io/name: prometheus
        app.kubernetes.io/instance: prometheus

  extraVolumes:
    - name: thanos-objstore-config
      secret:
        secretName: minio-thanos-secret
        items:
          - key: object-storage.yaml
            path: objstore.yml
    - name: tmp
      emptyDir: {}
  extraVolumeMounts:
    - name: tmp
      mountPath: /tmp

# Scrape configuration for OpenTelemetry Collector
extraScrapeConfigs: |
  - job_name: 'otel-collector'
    scrape_interval: 10s
    static_configs:
      - targets: ['opentelemetry.observability:8888'] # Collector internal metrics
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: "otelcol_process_.*|up|scrape_.*"
        action: keep

# Scrape job configuration for single-node homelab
scrapeConfigs:
  kubernetes-service-endpoints:
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: "node_cpu_seconds_total|node_load(1|5|15)|node_memory_(MemTotal|MemAvailable|Buffers|Cached)_bytes|node_filesystem_(size|avail|free)_bytes|node_disk_(read|written)_bytes_total|node_disk_io_time_seconds_total|node_network_(receive|transmit)_bytes_total|node_hwmon_temp_celsius|node_boot_time_seconds|node_uname_info|kube_pod_status_phase|kube_pod_container_resource_requests|kube_pod_container_resource_limits|kube_pod_container_status_running|kube_pod_info|kube_deployment_status_replicas|kube_deployment_status_replicas_available|kube_deployment_spec_replicas|kube_node_status_allocatable|kube_node_status_capacity|kube_statefulset_status_replicas_ready|kube_statefulset_replicas|kube_daemonset_status_number_ready|kube_daemonset_status_desired_number_scheduled|kube_namespace_status_phase|up|scrape_.*"
        action: keep

  kubernetes-nodes-cadvisor:
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: "container_cpu_(usage_seconds_total|cfs_throttled_seconds_total|cfs_periods_total|cfs_throttled_periods_total)|container_memory_(working_set_bytes|rss|cache|usage_bytes)|container_network_(receive|transmit)_bytes_total|container_spec_(cpu_quota|cpu_period|memory_limit_bytes)|container_start_time_seconds|up|scrape_.*"
        action: keep

  prometheus:
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: "prometheus_tsdb_head_series|prometheus_tsdb_head_samples_appended_total|prometheus_tsdb_storage_blocks_bytes|prometheus_tsdb_wal_storage_size_bytes|prometheus_build_info|traces_.*|up|scrape_.*"
        action: keep

kube-state-metrics:
  revisionHistoryLimit: 3
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

prometheus-node-exporter:
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

# Disable unnecessary components to save resources
alertmanager:
  enabled: false
prometheus-pushgateway:
  enabled: false
